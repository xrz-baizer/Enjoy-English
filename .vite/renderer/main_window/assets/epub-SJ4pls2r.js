import{f as z,p as V,t as X,a as W}from"./index-DwDcCdzB.js";const b={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},I={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},T={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},G={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},J={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},B=i=>i.toLowerCase().replace(/[-:](.)/g,(t,e)=>e.toUpperCase()),K=i=>i?i.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",Q=(i,t,e)=>e?s=>s.getAttribute(i)?.split(/\s/)?.includes(t):typeof t=="function"?s=>t(s.getAttribute(i)):s=>s.getAttribute(i)===t,U=(...i)=>t=>t?Object.fromEntries(i.map(e=>[B(e),t.getAttribute(e)])):null,A=i=>K(i?.textContent),R=(i,t)=>{const e=i.lookupNamespaceURI(null)===t||i.lookupPrefix(t),s=e?(r,o)=>n=>n.namespaceURI===t&&n.localName===o:(r,o)=>n=>n.localName===o;return{$:(r,o)=>[...r.children].find(s(r,o)),$$:(r,o)=>[...r.children].filter(s(r,o)),$$$:e?(r,o)=>[...r.getElementsByTagNameNS(t,o)]:(r,o)=>[...r.getElementsByTagName(o)]}},M=(i,t)=>{try{if(t.includes(":"))return new URL(i,t);const e="https://invalid.invalid/",s=new URL(i,e+t);return s.search="",decodeURI(s.href.replace(e,""))}catch(e){return console.warn(e),i}},q=i=>/^(?!blob)\w+:/i.test(i),Y=(i,t)=>{if(!i)return t;const e=i.replace(/\/$/,"").split("/"),s=t.replace(/\/$/,"").split("/"),r=(e.length>s.length?e:s).findIndex((o,n)=>e[n]!==s[n]);return r<0?"":Array(e.length-r).fill("..").concat(s.slice(r)).join("/")},Z=i=>i.slice(0,i.lastIndexOf("/")+1),C=async(i,t,e)=>{const s=[];i.replace(t,(...o)=>(s.push(o),null));const r=[];for(const o of s)r.push(await e(...o));return i.replace(t,()=>r.shift())},tt=i=>i.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),O=i=>{for(const[e,s]of Object.entries(i))s==null?delete i[e]:Array.isArray(s)?(i[e]=s.filter(r=>r).map(r=>typeof r=="object"&&!Array.isArray(r)?O(r):r),i[e].length?i[e].length===1&&(i[e]=i[e][0]):delete i[e]):typeof s=="object"&&(i[e]=O(s),Object.keys(s).length||delete i[e]);const t=Object.keys(i);return t.length===1&&t[0]==="name"?i[t[0]]:i},et=i=>{const t=new Map(Object.entries(T)),e=i.documentElement.getAttributeNS(b.EPUB,"prefix")||i.documentElement.getAttribute("prefix");if(e)for(const[,s,r]of e.matchAll(/(.+): +(.+)[ \t\r\n]*/g))t.set(s,r);return t},F=(i,t)=>{if(!i)return null;const[e,s]=i.split(":"),r=s?e:null,o=s||e,n=t.get(r);return n?n+o:null},st=i=>{const{$:t}=R(i,b.OPF),e=t(i.documentElement,"metadata"),s=Object.groupBy(e.children,a=>a.namespaceURI===b.DC?"dc":a.namespaceURI===b.OPF&&a.localName==="meta"?a.hasAttribute("name")?"legacyMeta":"meta":""),r=e.getAttribute("xml:lang")??i.documentElement.getAttribute("xml:lang")??"und",o=et(i),n=a=>{const f=a.getAttribute("property"),w=a.getAttribute("scheme");return{property:F(f,o)??f,scheme:F(w,o)??w,lang:a.getAttribute("xml:lang"),value:A(a),props:c(a),attrs:Object.fromEntries(Array.from(a.attributes).filter(v=>v.namespaceURI===b.OPF).map(v=>[v.localName,v.value]))}},l=Map.groupBy(s.meta??[],a=>a.getAttribute("refines")),c=a=>{const f=l.get(a?"#"+a.getAttribute("id"):null);return f?Object.groupBy(f.map(n),w=>w.property):null},p=Object.fromEntries(Object.entries(Object.groupBy(s.dc,a=>a.localName)).map(([a,f])=>[a,f.map(n)])),d=c()??{},h=Object.fromEntries(s.legacyMeta?.map(a=>[a.getAttribute("name"),a.getAttribute("content")])??[]),u=a=>a?.[0]?.value,g=(a,f)=>u(a?.props?.[f]),m=a=>{if(!a)return null;const f=a.props?.["alternate-script"]??[],w=a.attrs["alt-rep"];if(!f.length&&(!a.lang||a.lang===r)&&!w)return a.value;const v={[a.lang??r]:a.value};w&&(v[a.attrs["alt-rep-lang"]]=w);for(const D of f)v[D.lang]??=D.value;return v},y=a=>a?{name:m(a),sortAs:m(a.props?.["file-as"]?.[0])??a.attrs["file-as"],role:a.props?.role?.filter(f=>f.scheme===T.marc+"relators")?.map(f=>f.value)??[a.attrs.role],code:g(a,"term")??a.attrs.term,scheme:g(a,"authority")??a.attrs.authority}:null,E=a=>({name:m(a),position:u(a.props?.["group-position"])}),S=a=>{const{value:f}=a;if(/^urn:/i.test(f))return f;if(/^doi:/i.test(f))return`urn:${f}`;const w=a.props?.["identifier-type"];if(!w){const v=a.attrs.scheme;return v?/^(doi|isbn|uuid)$/i.test(v)?`urn:${v}:${f}`:{scheme:v,value:f}:f}if(w.scheme===T.onix+"codelist5"){const v=J[w.value];if(v)return`urn:${v}:${f}`}return f},$=Object.groupBy(d["belongs-to-collection"]??[],a=>g(a,"collection-type")==="series"?"series":"collection"),x=p.title?.find(a=>g(a,"title-type")==="main")??p.title?.[0],L={identifier:_(i),title:m(x),sortAs:m(x?.props?.["file-as"]?.[0])??x?.attrs?.["file-as"]??h?.["calibre:title_sort"],subtitle:p.title?.find(a=>g(a,"title-type")==="subtitle")?.value,language:p.language?.map(a=>a.value),description:u(p.description),publisher:y(p.publisher?.[0]),published:p.date?.find(a=>a.attrs.event==="publication")?.value??u(p.date),modified:u(d[T.dcterms+"modified"])??p.date?.find(a=>a.attrs.event==="modification")?.value,subject:p.subject?.map(y),belongsTo:{collection:$.collection?.map(E),series:$.series?.map(E)??h?.["calibre:series"]?{name:h?.["calibre:series"],position:parseFloat(h?.["calibre:series_index"])}:null},altIdentifier:p.identifier?.map(S),source:p.source?.map(S),rights:u(p.rights)},P=a=>f=>{const w=new Set(f.role?.map(v=>G[v]??a));return[w.size?w:[a],f]};for(const[a,f]of[].concat(p.creator?.map(y)?.map(P("author"))??[],p.contributor?.map(y)?.map(P("contributor"))??[]))for(const w of a)L[w]?L[w].push(f):L[w]=[f];O(L),L.altIdentifier===L.identifier&&delete L.altIdentifier;const H={},N={};for(const[a,f]of Object.entries(d))a.startsWith(T.rendition)?H[B(a.replace(T.rendition,""))]=u(f):a.startsWith(T.media)&&(N[B(a.replace(T.media,""))]=u(f));return N.duration&&(N.duration=k(N.duration)),{metadata:L,rendition:H,media:N}},rt=(i,t=e=>e)=>{const{$:e,$$:s,$$$:r}=R(i,b.XHTML),o=m=>m?decodeURI(t(m)):null,n=m=>y=>{const E=e(y,"a")??e(y,"span"),S=e(y,"ol"),$=o(E?.getAttribute("href")),L={label:A(E)||E?.getAttribute("title"),href:$,subitems:l(S)};return m&&(L.type=E?.getAttributeNS(b.EPUB,"type")?.split(/\s/)),L},l=(m,y)=>m?s(m,"li").map(n(y)):null,c=(m,y)=>l(e(m,"ol"),y),p=r(i,"nav");let d=null,h=null,u=null,g=[];for(const m of p){const y=m.getAttributeNS(b.EPUB,"type")?.split(/\s/)??[];y.includes("toc")?d??=c(m):y.includes("page-list")?h??=c(m):y.includes("landmarks")?u??=c(m,!0):g.push({label:A(m.firstElementChild),type:y,list:c(m)})}return{toc:d,pageList:h,landmarks:u,others:g}},it=(i,t=e=>e)=>{const{$:e,$$:s}=R(i,b.NCX),r=c=>c?decodeURI(t(c)):null,o=c=>{const p=e(c,"navLabel"),d=e(c,"content"),h=A(p),u=r(d.getAttribute("src"));if(c.localName==="navPoint"){const g=s(c,"navPoint");return{label:h,href:u,subitems:g.length?g.map(o):null}}return{label:h,href:u}},n=(c,p)=>s(c,p).map(o),l=(c,p)=>{const d=e(i.documentElement,c);return d?n(d,p):null};return{toc:l("navMap","navPoint"),pageList:l("pageList","pageTarget"),others:s(i.documentElement,"navList").map(c=>({label:A(e(c,"navLabel")),list:n(c,"navTarget")}))}},k=i=>{if(!i)return;const t=i.split(":").map(n=>parseFloat(n));if(t.length===3){const[n,l,c]=t;return n*60*60+l*60+c}if(t.length===2){const[n,l]=t;return n*60+l}const[e,s]=i.split(/(?=[^\d.])/),r=parseFloat(e),o=s==="h"?60*60:s==="min"?60:s==="ms"?.001:1;return r*o};class nt extends EventTarget{#e;#s;#t;#n;#i;#r;#d=1;#f=1;#l;constructor(t,e){super(),this.book=t,this.loadXML=e}async#g(t){if(this.#s===t)return;const e=await this.loadXML(t.href),s=n=>n?M(n,t.href):null,{$:r,$$$:o}=R(e,b.SMIL);this.#n=-1,this.#i=-1,this.#e=o(e,"par").reduce((n,l)=>{const c=s(r(l,"text")?.getAttribute("src")),p=r(l,"audio");if(!c||!p)return n;const d=s(p.getAttribute("src")),h=k(p.getAttribute("clipBegin")),u=k(p.getAttribute("clipEnd")),g=n.at(-1);return g?.src===d?g.items.push({text:c,begin:h,end:u}):n.push({src:d,items:[{text:c,begin:h,end:u}]}),n},[]),this.#s=t}get#h(){return this.#e[this.#n]}get#a(){return this.#h?.items?.[this.#i]}#o(t){console.error(t),this.dispatchEvent(new CustomEvent("error",{detail:t}))}#p(){this.dispatchEvent(new CustomEvent("highlight",{detail:this.#a}))}#u(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:this.#a}))}async#c(t,e){this.#m(),this.#n=t,this.#i=e;const s=this.#h?.src;if(!s||!this.#a)return this.start(this.#t+1);const r=URL.createObjectURL(await this.book.loadBlob(s)),o=new Audio(r);this.#r=o,o.volume=this.#d,o.playbackRate=this.#f,o.addEventListener("timeupdate",()=>{if(o.paused)return;const n=o.currentTime,{items:l}=this.#h;if(n>this.#a?.end&&(this.#u(),this.#i===l.length-1)){this.#c(this.#n+1,0).catch(p=>this.#o(p));return}const c=this.#i;for(;l[this.#i+1]?.begin<=n;)this.#i++;this.#i!==c&&this.#p()}),o.addEventListener("error",()=>this.#o(new Error(`Failed to load ${s}`))),o.addEventListener("playing",()=>this.#p()),o.addEventListener("ended",()=>{this.#u(),URL.revokeObjectURL(r),this.#r=null,this.#c(t+1,0).catch(n=>this.#o(n))}),this.#l==="paused"?(this.#p(),o.currentTime=this.#a.begin??0):o.addEventListener("canplaythrough",()=>{o.currentTime=this.#a.begin??0,this.#l="playing",o.play().catch(n=>this.#o(n))},{once:!0})}async start(t,e=()=>!0){this.#r?.pause();const s=this.book.sections[t],r=s?.id;if(!r)return;const{mediaOverlay:o}=s;if(!o)return this.start(t+1);this.#t=t,await this.#g(o);for(let n=0;n<this.#e.length;n++){const{items:l}=this.#e[n];for(let c=0;c<l.length;c++)if(l[c].text.split("#")[0]===r&&e(l[c],c,l))return this.#c(n,c).catch(p=>this.#o(p))}}pause(){this.#l="paused",this.#r?.pause()}resume(){this.#l="playing",this.#r?.play().catch(t=>this.#o(t))}#m(){this.#r&&(this.#r.pause(),URL.revokeObjectURL(this.#r.src),this.#r=null,this.#u())}stop(){this.#l="stopped",this.#m()}prev(){this.#i>0?this.#c(this.#n,this.#i-1):this.#n>0?this.#c(this.#n-1,this.#e[this.#n-1].items.length-1):this.#t>0&&this.start(this.#t-1,(t,e,s)=>e===s.length-1)}next(){this.#c(this.#n,this.#i+1)}setVolume(t){this.#d=t,this.#r&&(this.#r.volume=t)}setRate(t){this.#f=t,this.#r&&(this.#r.playbackRate=t)}}const at=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,ot=i=>{for(const t of i.getElementsByTagNameNS(b.DC,"identifier")){const[e]=A(t).split(":").slice(-1);if(at.test(e))return e}return""},_=i=>A(i.getElementById(i.documentElement.getAttribute("unique-identifier"))??i.getElementsByTagNameNS(b.DC,"identifier")[0]),j=async(i,t,e)=>{const s=new Uint8Array(await e.slice(0,t).arrayBuffer());t=Math.min(t,s.length);for(var r=0;r<t;r++)s[r]=s[r]^i[r%i.length];return new Blob([s,e.slice(t)],{type:e.type})},ct=async i=>{const t=new TextEncoder().encode(i),e=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(e)},lt=(i=ct)=>({"http://www.idpf.org/2008/embedding":{key:t=>i(_(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(t,e)=>j(t,1040,e)},"http://ns.adobe.com/pdf/enc#RC":{key:t=>{const e=ot(t).replaceAll("-","");return Uint8Array.from({length:16},(s,r)=>parseInt(e.slice(r*2,r*2+2),16))},decode:(t,e)=>j(t,1024,e)}});class ht{#e=new Map;#s=new Map;#t;constructor(t){this.#t=t}async init(t,e){if(!t)return;const s=Array.from(t.getElementsByTagNameNS(b.ENC,"EncryptedData"),r=>({algorithm:r.getElementsByTagNameNS(b.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:r.getElementsByTagNameNS(b.ENC,"CipherReference")[0]?.getAttribute("URI")}));for(const{algorithm:r,uri:o}of s){if(!this.#s.has(r)){const n=this.#t[r];if(!n){console.warn("Unknown encryption algorithm");continue}const l=await n.key(e);this.#s.set(r,c=>n.decode(l,c))}this.#e.set(o,r)}}getDecoder(t){return this.#s.get(this.#e.get(t))??(e=>e)}}class pt{constructor({opf:t,resolveHref:e}){this.opf=t;const{$:s,$$:r,$$$:o}=R(t,b.OPF),n=s(t.documentElement,"manifest"),l=s(t.documentElement,"spine"),c=r(l,"itemref");this.manifest=r(n,"item").map(U("href","id","media-type","properties","media-overlay")).map(d=>(d.href=e(d.href),d.properties=d.properties?.split(/\s/),d)),this.manifestById=new Map(this.manifest.map(d=>[d.id,d])),this.spine=c.map(U("idref","id","linear","properties")).map(d=>(d.properties=d.properties?.split(/\s/),d)),this.pageProgressionDirection=l.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(l.getAttribute("toc"))??this.manifest.find(d=>d.mediaType===I.NCX))?.href;const p=s(t.documentElement,"guide");p&&(this.guide=r(p,"reference").map(U("type","title","href")).map(({type:d,title:h,href:u})=>({label:h,type:d.split(/\s/),href:e(u)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(o(t,"meta").find(Q("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find(d=>d.type.includes("cover"))?.href),this.cfis=z(c)}getItemByID(t){return this.manifestById.get(t)}getItemByHref(t){return this.manifest.find(e=>e.href===t)}getItemByProperty(t){return this.manifest.find(e=>e.properties?.includes(t))}resolveCFI(t){const e=V(t),s=(e.parent??e).shift();let r=X(this.opf,s);r&&r.nodeName!=="idref"&&(s.at(-1).id=null,r=X(this.opf,s));const o=r?.getAttribute("idref");return{index:this.spine.findIndex(c=>c.idref===o),anchor:c=>W(c,e)}}}class ut{#e=new Map;#s=new Map;#t=new Map;allowScript=!1;eventTarget=new EventTarget;constructor({loadText:t,loadBlob:e,resources:s}){this.loadText=t,this.loadBlob=e,this.manifest=s.manifest,this.assets=s.manifest}async createURL(t,e,s,r){if(!e)return"";const o={data:e,type:s};Object.defineProperty(o,"name",{value:t});const n=new CustomEvent("data",{detail:o});this.eventTarget.dispatchEvent(n);const l=await n.detail.data,c=await n.detail.type,p=URL.createObjectURL(new Blob([l],{type:c}));if(this.#e.set(t,p),this.#t.set(t,1),r){const d=this.#s.get(r);d?d.push(t):this.#s.set(r,[t])}return p}ref(t,e){const s=this.#s.get(e);return s?.includes(t)||(this.#t.set(t,this.#t.get(t)+1),s?s.push(t):this.#s.set(e,[t])),this.#e.get(t)}unref(t){if(!this.#t.has(t))return;const e=this.#t.get(t)-1;if(e<1){URL.revokeObjectURL(this.#e.get(t)),this.#e.delete(t),this.#t.delete(t);const s=this.#s.get(t);if(s)for(;s.length;)this.unref(s.pop());this.#s.delete(t)}else this.#t.set(t,e)}async loadItem(t,e=[]){if(!t)return null;const{href:s,mediaType:r}=t,o=I.JS.test(t.mediaType);if(o&&!this.allowScript)return null;const n=e.at(-1);if(this.#e.has(s))return this.ref(s,n);if((o||[I.XHTML,I.HTML,I.CSS,I.SVG].includes(r))&&e.every(p=>p!==s))return this.loadReplaced(t,e);const c=Promise.resolve().then(()=>this.loadBlob(s));return this.createURL(s,c,r,n)}async loadHref(t,e,s=[]){if(q(t))return t;const r=M(t,e),o=this.manifest.find(n=>n.href===r);return o?this.loadItem(o,s.concat(e)):t}async loadReplaced(t,e=[]){const{href:s,mediaType:r}=t,o=e.at(-1);let n="";try{n=await this.loadText(s)}catch(c){return this.createURL(s,Promise.reject(c),r,o)}if(!n)return null;if([I.XHTML,I.HTML,I.SVG].includes(r)){let c=new DOMParser().parseFromString(n,r);if(r===I.XHTML&&(c.querySelector("parsererror")||!c.documentElement?.namespaceURI)&&(console.warn(c.querySelector("parsererror")?.innerText??"Invalid XHTML"),t.mediaType=I.HTML,c=new DOMParser().parseFromString(n,t.mediaType)),[I.XHTML,I.SVG].includes(t.mediaType)){let h=c.firstChild;for(;h instanceof ProcessingInstruction;){if(h.data){const u=await C(h.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(g,m,y,E)=>this.loadHref(y,s,e).then(S=>`${m}${S}${E}`));h.replaceWith(c.createProcessingInstruction(h.target,u))}h=h.nextSibling}}const p=async(h,u)=>h.setAttribute(u,await this.loadHref(h.getAttribute(u),s,e));for(const h of c.querySelectorAll("link[href]"))await p(h,"href");for(const h of c.querySelectorAll("[src]"))await p(h,"src");for(const h of c.querySelectorAll("[poster]"))await p(h,"poster");for(const h of c.querySelectorAll("object[data]"))await p(h,"data");for(const h of c.querySelectorAll("[*|href]:not([href])"))h.setAttributeNS(b.XLINK,"href",await this.loadHref(h.getAttributeNS(b.XLINK,"href"),s,e));for(const h of c.querySelectorAll("style"))h.textContent&&(h.textContent=await this.replaceCSS(h.textContent,s,e));for(const h of c.querySelectorAll("[style]"))h.setAttribute("style",await this.replaceCSS(h.getAttribute("style"),s,e));const d=new XMLSerializer().serializeToString(c);return this.createURL(s,d,t.mediaType,o)}const l=r===I.CSS?await this.replaceCSS(n,s,e):await this.replaceString(n,s,e);return this.createURL(s,l,r,o)}async replaceCSS(t,e,s=[]){const r=await C(t,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(o,n)=>this.loadHref(n,e,s).then(l=>`url("${l}")`));return C(r,/@import\s*["']([^"'\n]*?)["']/gi,(o,n)=>this.loadHref(n,e,s).then(l=>`@import "${l}"`))}replaceString(t,e,s=[]){const r=new Map,o=this.assets.map(l=>{if(l.href===e)return;const c=Y(Z(e),l.href),p=encodeURI(c),d="/"+l.href,h=encodeURI(d),u=new Set([c,p,d,h]);for(const g of u)r.set(g,l);return Array.from(u)}).flat().filter(l=>l);if(!o.length)return t;const n=new RegExp(o.map(tt).join("|"),"g");return C(t,n,async l=>this.loadItem(r.get(l.replace(/^\//,"")),s.concat(e)))}unloadItem(t){this.unref(t?.href)}destroy(){for(const t of this.#e.values())URL.revokeObjectURL(t)}}const dt=(i,t)=>i.getElementById(t)??i.querySelector(`[name="${CSS.escape(t)}"]`),ft=i=>{for(const t of i){if(t==="page-spread-left"||t==="rendition:page-spread-left")return"left";if(t==="page-spread-right"||t==="rendition:page-spread-right")return"right";if(t==="rendition:page-spread-center")return"center"}},mt=i=>i?{fixedLayout:A(i.querySelector('option[name="fixed-layout"]')),openToSpread:A(i.querySelector('option[name="open-to-spread"]'))}:null;class yt{parser=new DOMParser;#e;#s;constructor({loadText:t,loadBlob:e,getSize:s,sha1:r}){this.loadText=t,this.loadBlob=e,this.getSize=s,this.#s=new ht(lt(r))}async#t(t){const e=await this.loadText(t);if(!e)return null;const s=this.parser.parseFromString(e,I.XML);if(s.querySelector("parsererror"))throw new Error(`XML parsing error: ${t}
${s.querySelector("parsererror").innerText}`);return s}async init(){const t=await this.#t("META-INF/container.xml");if(!t)throw new Error("Failed to load container file");const e=Array.from(t.getElementsByTagNameNS(b.CONTAINER,"rootfile"),U("full-path","media-type")).filter(u=>u.mediaType==="application/oebps-package+xml");if(!e.length)throw new Error("No package document defined in container");const s=e[0].fullPath,r=await this.#t(s);if(!r)throw new Error("Failed to load package document");const o=await this.#t("META-INF/encryption.xml");await this.#s.init(o,r),this.resources=new pt({opf:r,resolveHref:u=>M(u,s)}),this.#e=new ut({loadText:this.loadText,loadBlob:u=>Promise.resolve(this.loadBlob(u)).then(this.#s.getDecoder(u)),resources:this.resources}),this.transformTarget=this.#e.eventTarget,this.sections=this.resources.spine.map((u,g)=>{const{idref:m,linear:y,properties:E=[]}=u,S=this.resources.getItemByID(m);return S?{id:S.href,load:()=>this.#e.loadItem(S),unload:()=>this.#e.unloadItem(S),createDocument:()=>this.loadDocument(S),size:this.getSize(S.href),cfi:this.resources.cfis[g],linear:y,pageSpread:ft(E),resolveHref:$=>M($,S.href),mediaOverlay:S.mediaOverlay?this.resources.getItemByID(S.mediaOverlay):null}:(console.warn(`Could not find item with ID "${m}" in manifest`),null)}).filter(u=>u);const{navPath:n,ncxPath:l}=this.resources;if(n)try{const u=m=>M(m,n),g=rt(await this.#t(n),u);this.toc=g.toc,this.pageList=g.pageList,this.landmarks=g.landmarks}catch(u){console.warn(u)}if(!this.toc&&l)try{const u=m=>M(m,l),g=it(await this.#t(l),u);this.toc=g.toc,this.pageList=g.pageList}catch(u){console.warn(u)}this.landmarks??=this.resources.guide;const{metadata:c,rendition:p,media:d}=st(r);this.metadata=c,this.rendition=p,this.media=d,this.dir=this.resources.pageProgressionDirection;const h=mt(await this.#t("META-INF/com.apple.ibooks.display-options.xml")??await this.#t("META-INF/com.kobobooks.display-options.xml"));return h&&(h.fixedLayout==="true"&&(this.rendition.layout??="pre-paginated"),h.openToSpread==="false"&&(this.sections.find(u=>u.linear!=="no").pageSpread??=this.dir==="rtl"?"left":"right")),this}async loadDocument(t){const e=await this.loadText(t.href);return this.parser.parseFromString(e,t.mediaType)}getMediaOverlay(){return new nt(this,this.#t.bind(this))}resolveCFI(t){return this.resources.resolveCFI(t)}resolveHref(t){const[e,s]=t.split("#"),r=this.resources.getItemByHref(decodeURI(e));return r?{index:this.resources.spine.findIndex(({idref:l})=>l===r.id),anchor:s?l=>dt(l,s):()=>0}:null}splitTOCHref(t){return t?.split("#")??[]}getTOCFragment(t,e){return t.getElementById(e)??t.querySelector(`[name="${CSS.escape(e)}"]`)}isExternal(t){return q(t)}async getCover(){const t=this.resources?.cover;return t?.href?new Blob([await this.loadBlob(t.href)],{type:t.mediaType}):null}async getCalibreBookmarks(){const t=await this.loadText("META-INF/calibre_bookmarks.txt"),e="encoding=json+base64:";if(t?.startsWith(e)){const s=atob(t.slice(e.length));return JSON.parse(s)}}destroy(){this.#e?.destroy()}}export{yt as EPUB};
//# sourceMappingURL=epub-SJ4pls2r.js.map
