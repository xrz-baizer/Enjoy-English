const a={XML:"http://www.w3.org/XML/1998/namespace",SSML:"http://www.w3.org/2001/10/synthesis"},M=new Set(["article","aside","audio","blockquote","caption","details","dialog","div","dl","dt","dd","figure","footer","form","figcaption","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","math","nav","ol","p","pre","section","tr"]),p=s=>{const t=s.lang||s?.getAttributeNS?.(a.XML,"lang");return t||(s.parentElement?p(s.parentElement):null)},b=s=>{const t=s?.getAttributeNS?.(a.XML,"lang");return t||(s.parentElement?b(s.parentElement):null)},N=(s="en",t="word")=>{const e=new Intl.Segmenter(s,{granularity:t}),n=t==="word";return function*(i,o){const l=i.join("");let g=0,r=-1,h=0;for(const{index:u,segment:f,isWordLike:c}of e.segment(l)){if(n&&!c)continue;for(;h<=u;)h+=i[++r].length;const m=r,w=u-(h-i[r].length),d=u+f.length-1;if(d<l.length)for(;h<=d;)h+=i[++r].length;const x=r,L=d-(h-i[r].length)+1;yield[(g++).toString(),o(m,w,x,L)]}}},E=(s,t)=>{const e=document.implementation.createDocument(a.SSML,"speak"),{lang:n}=t;n&&e.documentElement.setAttributeNS(a.XML,"lang",n);const i=(o,l,g)=>{if(!o)return;if(o.nodeType===3)return e.createTextNode(o.textContent);if(o.nodeType===4)return e.createCDATASection(o.textContent);if(o.nodeType!==1)return;let r;const h=o.nodeName.toLowerCase();h==="foliate-mark"?(r=e.createElementNS(a.SSML,"mark"),r.setAttribute("name",o.dataset.name)):h==="br"?r=e.createElementNS(a.SSML,"break"):(h==="em"||h==="strong")&&(r=e.createElementNS(a.SSML,"emphasis"));const u=o.lang||o.getAttributeNS(a.XML,"lang");u&&(r||(r=e.createElementNS(a.SSML,"lang")),r.setAttributeNS(a.XML,"lang",u));const f=o.getAttributeNS(a.SSML,"alphabet")||g;if(!r){const m=o.getAttributeNS(a.SSML,"ph");m&&(r=e.createElementNS(a.SSML,"phoneme"),f&&r.setAttribute("alphabet",f),r.setAttribute("ph",m))}r||(r=l);let c=o.firstChild;for(;c;){const m=i(c,r,f);m&&r!==m&&r.append(m),c=c.nextSibling}return r};return i(s.firstChild,e.documentElement,t.alphabet),e},T=(s,t,e)=>{const n=p(s.commonAncestorContainer),i=b(s.commonAncestorContainer),o=N(n,e),l=s.cloneContents(),g=[...t(s,o)],r=[...t(l,o)];for(const[u,f]of r){const c=document.createElement("foliate-mark");c.dataset.name=u,f.insertNode(c)}const h=E(l,{lang:n,alphabet:i});return{entries:g,ssml:h}},S=s=>!s.toString().trim();function*k(s){let t;const e=s.createTreeWalker(s.body,NodeFilter.SHOW_ELEMENT);for(let n=e.nextNode();n;n=e.nextNode()){const i=n.tagName.toLowerCase();M.has(i)&&(t&&(t.setEndBefore(n),S(t)||(yield t)),t=s.createRange(),t.setStart(n,0))}t||(t=s.createRange(),t.setStart(s.body.firstChild??s.body,0)),t.setEndAfter(s.body.lastChild??s.body),S(t)||(yield t)}class A{#t=[];#i;#e=-1;#n;constructor(t,e=n=>n){this.#i=t,this.#n=e}current(){if(this.#t[this.#e])return this.#n(this.#t[this.#e])}first(){if(this.#t[0])return this.#e=0,this.#n(this.#t[0])}prev(){const t=this.#e-1;if(this.#t[t])return this.#e=t,this.#n(this.#t[t])}next(){const t=this.#e+1;if(this.#t[t])return this.#e=t,this.#n(this.#t[t]);for(;;){const{done:e,value:n}=this.#i.next();if(e)break;if(this.#t.push(n),this.#t[t])return this.#e=t,this.#n(this.#t[t])}}find(t){const e=this.#t.findIndex(n=>t(n));if(e>-1)return this.#e=e,this.#n(this.#t[e]);for(;;){const{done:n,value:i}=this.#i.next();if(n)break;if(this.#t.push(i),t(i))return this.#e=this.#t.length-1,this.#n(i)}}}class y{#t;#i;#e;#n=new XMLSerializer;constructor(t,e,n,i){this.doc=t,this.highlight=n,this.#t=new A(k(t),o=>{const{entries:l,ssml:g}=T(o,e,i);return this.#i=new Map(l),[g,o]})}#r(t,e){return e?t.querySelector(`mark[name="${CSS.escape(e)}"`):null}#s(t,e){if(!t)return;if(!e)return this.#n.serializeToString(t);const n=document.implementation.createDocument(a.SSML,"speak");n.documentElement.replaceWith(n.importNode(t.documentElement,!0));let i=e(n)?.previousSibling;for(;i;){const o=i.previousSibling??i.parentNode?.previousSibling;i.parentNode.removeChild(i),i=o}return this.#n.serializeToString(n)}start(){this.#e=null;const[t]=this.#t.first()??[];return t?this.#s(t,e=>this.#r(e,this.#e)):this.next()}resume(){const[t]=this.#t.current()??[];return t?this.#s(t,e=>this.#r(e,this.#e)):this.next()}prev(t){this.#e=null;const[e,n]=this.#t.prev()??[];return t&&n&&this.highlight(n.cloneRange()),this.#s(e)}next(t){this.#e=null;const[e,n]=this.#t.next()??[];return t&&n&&this.highlight(n.cloneRange()),this.#s(e)}from(t){this.#e=null;const[e]=this.#t.find(i=>t.compareBoundaryPoints(Range.END_TO_START,i)<=0);let n;for(const[i,o]of this.#i.entries())if(t.compareBoundaryPoints(Range.START_TO_START,o)<=0){n=i;break}return this.#s(e,i=>this.#r(i,n))}setMark(t){const e=this.#i.get(t);e&&(this.#e=t,this.highlight(e.cloneRange()))}}export{y as TTS};
//# sourceMappingURL=tts-ColYPQ7G.js.map
